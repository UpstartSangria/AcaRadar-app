doctype html
html lang='en'
  head
    meta charset='utf-8'
    meta name='viewport' content='width=device-width, initial-scale=1'
    title Selected Journals - AcaRadar
    script src="https://cdn.jsdelivr.net/npm/chart.js"
    script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
  body
    .container-fluid.mt-4
      - if error
        .alert.alert-danger.show = error
      h4.mt-4 You have selected the following journals: #{journals.inspect}. We found #{papers.count} papers in total!
      - if papers.any?
        - plot_data = []
        - ri_plot_data = (research_interest_2d && research_interest_2d.size >= 2) ? [{ x: research_interest_2d[0], y: research_interest_2d[1], label: research_interest_term }] : []
        h3.mt-4 Papers
        #papersAccordion.accordion.mb-4
          - papers.each_with_index do |paper, index|
            - plot_data << { x: paper.two_dim_embedding[0], y: paper.two_dim_embedding[1], label: paper.title, pdfUrl: paper.pdf_url }
            .accordion-item
              h2.accordion-header id="heading-#{index}"
                button.accordion-button.collapsed type="button" data-bs-toggle="collapse" data-bs-target="#collapse-#{index}" aria-expanded="false" aria-controls="collapse-#{index}"
                  = paper.title
              .accordion-collapse.collapse id="collapse-#{index}" aria-labelledby="heading-#{index}" data-bs-parent="#papersAccordion"
                .accordion-body
                  h6.card-subtitle.mb-2.text-muted Published: #{paper.published}
                  p.card-text.mt-3 = paper.short_summary
                  p.card-text.mt-3 = paper.pdf_url
                  hr
                  h6 Concepts:
                  ul.list-group.list-group-flush
                    - paper.concepts_list.to_s.split(',').each do |concept|
                      li.list-group-item = concept.strip
                  .mt-3
                    small.text-muted

        h3.mt-4 Concept Visualization
        p Research Interest term: #{research_interest_term.inspect}
        p Reseatch Interest 2D: #{research_interest_2d.inspect}
        canvas#concept-chart data-paper-points=plot_data.to_json data-ri-points=ri_plot_data.to_json
      - else
        p No papers found.
    javascript:
      document.addEventListener('DOMContentLoaded', () => {
        const canvas = document.getElementById('concept-chart');
        if (canvas) {
          // 1. Get the data from our data-points attribute
          const paperPointsJSON = canvas.dataset.paperPoints;
          const riPointsJSON = canvas.dataset.riPoints;
          const paperPoints = JSON.parse(paperPointsJSON);
          const riPoints = JSON.parse(riPointsJSON);
          // 2. Define our custom plugin to draw the circle on hover
          const hoverCirclePlugin = {
            id: 'hoverCircle',
            // We use afterEvent to track the mouse position and see what it's hovering over
            afterEvent: (chart, args, options) => {
              const event = args.event;

              if (event.type === 'mousemove') {
                const activeElements = chart.getActiveElements();
                if (activeElements.length > 0) {
                  // Store the hovered element's info for the drawing phase
                  chart.hoveredElement = activeElements[0];
                } else {
                  chart.hoveredElement = null;
                }
                // Redraw the chart to show/hide the circle
                chart.draw();
              } else if (event.type === 'mouseout') {
                chart.hoveredElement = null;
                chart.draw();
              }
            },
            // afterDatasetsDraw allows us to draw on top of the chart datasets
            afterDatasetsDraw: (chart, args, options) => {
              const { ctx } = chart;
              const hoveredElement = chart.hoveredElement;
              if (hoveredElement) {
                ctx.save();

                // Get the pixel coordinates of the hovered point
                const x = hoveredElement.element.x;
                const y = hoveredElement.element.y;

                // Use a fixed pixel radius for visibility (adjust as needed)
                const pixelRadius = 400;

                // Style the circle
                ctx.beginPath();
                ctx.strokeStyle = 'rgba(0, 0, 0, 0.6)'; // Circle color
                ctx.lineWidth = 2; // Circle line width
                ctx.setLineDash([4, 4]); // 4px dash, 4px space

                // Draw the circle
                ctx.arc(x, y, pixelRadius, 0, 2 * Math.PI);

                ctx.stroke();
                ctx.restore();
              }
            }
          };
          // 3. Register the plugin globally
          Chart.register(hoverCirclePlugin);
          // 4. Create the Chart.js scatter plot
          new Chart(canvas, {
            type: 'scatter',
            data: {
              datasets: [
                {
                  label: 'Paper Concepts',
                  data: paperPoints,
                  backgroundColor: 'rgb(54, 162, 235)'
                },
                {
                  label: 'Research Interest',
                  data: riPoints,
                  backgroundColor: 'rgb(255, 99, 132)',
                  pointRadius: 7,
                  pointHoverRadius: 10
                }
              ]
            },
            options: {
              onClick: (event, elements) => {
                if (elements.length > 0) {
                  const element = elements[0];
                  const datasetIndex = element.datasetIndex;
                  const dataIndex = element.index;
                  const pointData = event.chart.data.datasets[datasetIndex].data[dataIndex];
                  if (pointData.pdfUrl) {
                    window.open(pointData.pdfUrl, '_blank'); // Opens PDF in new tab
                  }
                }
              },
              scales: {
                x: {
                  title: {
                    display: true,
                    text: 'Dimension 1'
                  }
                },
                y: {
                  title: {
                    display: true,
                    text: 'Dimension 2'
                  }
                }
              },
              plugins: {
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      // Show the paper's title or research interest in the tooltip on hover
                      return context.raw.label;
                    }
                  }
                }
              }
            }
          });
        }
      });