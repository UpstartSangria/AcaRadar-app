script src="http://localhost:9292/faye/client.js"
.container-fluid

  / ===== Flash / Error Area =====
  - if flash[:error]
    .alert.alert-danger.mt-3 role="alert"
      = flash[:error]
  - if flash[:notice]
    .alert.alert-success.mt-3 role="alert"
      = flash[:notice]

  / JS-driven flash area (for AJAX errors)
  .alert.mt-3.d-none id="flash-area" role="alert"
    span id="flash-text"

.container-fluid
  hr.my-4
  form role="form" id="research-interest-form"
    .row.align-items-center
      .col-md-2.d-flex.align-items-center
        .h4.mb-0.fw-bold Research Interest
      .col-md-8
        input.form-control type="text" name="term" id="research_interest_input" placeholder="Please enter your research interest"
        .progress.mt-2.d-none id="search-progress"
          .progress-bar.progress-bar-striped.progress-bar-animated role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 75%;"
      .col-md-2
        button type="submit" id="embed-button" class="btn btn-primary w-100"
          span.spinner-grow.spinner-grow-sm.d-none role="status" aria-hidden="true"
          span.button-text Embed

    hr.my-4
  form role="form" action="/selected_journals" method='GET' id='find-journals-form'
    input type="hidden" name="request_id" id="request_id"

    .row.align-items-start.g-3
      .col-md-2.d-flex.align-items-center
        .h4.mb-0.fw-bold Select Journals

      .col-md-4
        label.form-label.fw-bold.mb-1 Journals
        select name='journals[]' id='journals_select' class="form-control" multiple=true size="8"
          - AcaRadar::View::JournalOption.all.each do |text, value|
            option value=value = text
        .form-text Select 1+ journals (Cmd/Ctrl+Click for multi-select)

      .col-md-2
        label.form-label.fw-bold.mb-1 Top N
        input.form-control type="number" name="top_n" id="top_n" min="1" max="200" placeholder="e.g. 25"
        .form-text
          | Leave blank for paged mode


      .col-md-2
        label.form-label.fw-bold.mb-1 From
        input.form-control type="date" name="min_date" id="min_date"

      .col-md-2
        label.form-label.fw-bold.mb-1 To
        input.form-control type="date" name="max_date" id="max_date"

    .row.mt-3
      .col-md-2.offset-md-10
        button type='submit' id='find-button' class="btn btn-primary w-100"
          span.spinner-grow.spinner-grow-sm.d-none role="status" aria-hidden="true"
          span.button-text Find

  hr.my-4
  h4.mb-3.fw-bold Previously Viewed Papers
  - if watched_papers.any?
    - watched_papers.each do |paper|
      .card.bg-light.mb-3
        .card-body
          h5.card-title
            a href=paper.origin_id target="_blank" rel="noopener noreferrer" = paper.title
          p.small.text-muted
            | Published on: #{paper.published}
          p.card-text
            = paper.summary
  - else
    .alert.alert-light role="alert"
      h4.alert-heading Welcome!
      p You haven't viewed any papers yet. Use the form above to find some interesting research papers.

  javascript:
    const API_HOST = "#{@api_host}";
    console.log("0. [Frontend] API defined:", API_HOST);
    document.addEventListener("DOMContentLoaded", function() {

      const flashArea = document.getElementById('flash-area');
      const flashText = document.getElementById('flash-text');

      function showFlash(type, msg) {
        if (!flashArea || !flashText) return;
        flashArea.classList.remove('d-none', 'alert-danger', 'alert-success', 'alert-warning', 'alert-info');
        flashArea.classList.add(type); // e.g. 'alert-danger'
        flashText.textContent = msg || 'Something went wrong.';
      }

      function clearFlash() {
        if (!flashArea || !flashText) return;
        flashText.textContent = '';
        flashArea.classList.add('d-none');
      }

      // ==========================================
      // 1. Research Interest Form (AJAX + Faye)
      // ==========================================
      const researchForm = document.getElementById('research-interest-form');
      const progressBarContainer = document.getElementById('search-progress');
      const progressBar = progressBarContainer ? progressBarContainer.querySelector('.progress-bar') : null;
      const embedButton = document.getElementById('embed-button');

      let researchInterestVector = null;
      let researchRequestId = null;
      let researchInterestRequestId = null;

      // Safety Check
      if (researchForm) {
        researchForm.addEventListener('submit', async function(e) {
          e.preventDefault(); // Stop page reload

          const termInput = document.getElementById('research_interest_input').value;
          console.log("1. [Frontend] Form submitted. Term:", termInput);

          // --- A. RESET UI ---
          embedButton.disabled = true;
          embedButton.querySelector('.button-text').innerText = "Starting...";
          clearFlash();
          
          // Reset and show progress bar
          progressBarContainer.classList.remove('d-none');
          if(progressBar) {
              progressBar.style.width = '0%';
              progressBar.setAttribute('aria-valuenow', 0);
              progressBar.innerText = '0%';
              progressBar.classList.add('progress-bar-animated'); // Start animation
          }

          try {
            // --- B. CALL API (Port 9292) ---
            console.log("2. [Frontend] Sending POST request to ${API_HOST}...");
            
            const response = await fetch('/api_proxy/research_interest', {
              credentials: 'same-origin',
              method: 'POST',
              headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json' 
              },
              body: JSON.stringify({ term: termInput })
            });

            const result = await response.json().catch(() => ({}));
            const data = result.data || {};

            if (!response.ok) {
              // API returns message + data.error; prefer the friendliest
              const msg =
                (data && (data.error || data.message)) ||
                result.message ||
                `Server Error: ${response.status} ${response.statusText}`;
              throw new Error(msg);
            }

            console.log("3. [Frontend] API Response received:", result);

            // --- C. GET REQUEST ID ---
            // Based on your logs, the structure is inside result.data.request_id
            const requestId = data.request_id || null;

            if (!requestId) {
              throw new Error("Response did not contain a request_id in result.data");
            }

            // Make request_id available to the "Find" flow
            researchRequestId = requestId;
            const requestIdInput = document.getElementById('request_id');
            if (requestIdInput) requestIdInput.value = requestId;

            // Always store request_id so "Find" can use it
            researchInterestRequestId = requestId;

            if (data.status === 'completed' || data.cached) {
              researchInterestVector = data.vector_2d || null;

              if (progressBar) {
                progressBar.style.width = '100%';
                progressBar.setAttribute('aria-valuenow', 100);
                progressBar.innerText = '100%: Cached';
                progressBar.classList.remove('progress-bar-animated');
              }

              embedButton.disabled = false;
              embedButton.querySelector('.button-text').innerText = "Done";
              return;
            }

            console.log("4. [Frontend] Request ID obtained:", requestId);

            embedButton.querySelector('.button-text').innerText = "Processing...";

            // --- D. SUBSCRIBE TO FAYE ---
            // Ensure we point to port 9292
            if (!window.Faye) throw new Error("Faye client not loaded (window.Faye is undefined)");
            const client = new window.Faye.Client('http://localhost:9292/faye');
            
            console.log(`5. [Faye] Subscribing to channel: /${requestId}`);

            const subscription = client.subscribe('/' + requestId, function(message) {
              console.log("6. [Faye] Message Received:", message);

              // Expecting message format: { percent: 50, status: '...' }
              if (progressBar && message.percent !== undefined) {
                  const percentVal = message.percent;
                  const messageText = message.message;
                  progressBar.style.width = percentVal + '%';
                  progressBar.setAttribute('aria-valuenow', percentVal);
                  progressBar.innerText = `${percentVal}%: ${messageText}`;
              }

              // Check for Completion
              if (message.percent >= 100) {
                  console.log("7. [Faye] Job Complete!");

                  if (message.vector_2d) {
                  researchInterestVector = message.vector_2d;
                  console.log("8. [Frontend] Vector stored:", researchInterestVector);
                  }
                  
                  // Final UI Updates
                  progressBar.classList.remove('progress-bar-animated'); // Stop animation
                  embedButton.disabled = false;
                  embedButton.querySelector('.button-text').innerText = "Done";
              }
            });
            
            // Debugging Faye connection
            subscription.then(function() {
              console.log("5b. [Faye] Subscription active/successful.");
            });

          } catch (error) {
            console.error("!!! [Frontend] Error:", error);
            showFlash('alert-danger', error.message);

            // Reset button so user can try again
            if (progressBar) {
              progressBar.classList.remove('progress-bar-animated');
            }
            embedButton.disabled = false;
            embedButton.querySelector('.button-text').innerText = "Embed";
          }
        });
      } else {
        console.warn("Could not find element #research-interest-form");
      }

      // ==========================================
      // 2. Find Journals Form (multi-select + filters)
      // ==========================================
      const journalsForm = document.getElementById('find-journals-form');
      if (journalsForm) {
        const findButton = document.getElementById('find-button');

        if (findButton) {
          findButton.addEventListener('click', function(e) {
            e.preventDefault();

            const term = (document.getElementById('research_interest_input')?.value || '').trim();

            const journalsSelect = document.getElementById('journals_select');
            const selectedJournals = journalsSelect
              ? Array.from(journalsSelect.selectedOptions).map(o => o.value).filter(Boolean)
              : [];

            const topN = (document.getElementById('top_n')?.value || '').trim();
            const minDate = (document.getElementById('min_date')?.value || '').trim();
            const maxDate = (document.getElementById('max_date')?.value || '').trim();

            if (selectedJournals.length === 0) {
              alert('Please select at least one journal.');
              return;
            }

            // top_n requires a request_id (embedded research interest)
            if (topN && !researchRequestId) {
              alert("Please 'Embed' a research interest first (required for Top N).");
              return;
            }

            const params = new URLSearchParams();
            if (term) params.set('term', term);

            // IMPORTANT: keep brackets so Rack parses as array everywhere
            selectedJournals.forEach(j => params.append('journals[]', j));

            if (researchRequestId) params.set('request_id', researchRequestId);
            if (topN) params.set('top_n', topN);
            if (minDate) params.set('min_date', minDate);
            if (maxDate) params.set('max_date', maxDate);

            const newUrl = `/selected_journals?${params.toString()}`;
            console.log('Redirecting to:', newUrl);
            window.location.href = newUrl;
          });
        }
      }
    });
