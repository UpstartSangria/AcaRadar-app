script src="http://localhost:9292/faye/client.js"
.container-fluid

  / ===== Flash / Error Area =====
  - if flash[:error]
    .alert.alert-danger.mt-3 role="alert"
      = flash[:error]
  - if flash[:notice]
    .alert.alert-success.mt-3 role="alert"
      = flash[:notice]

  / JS-driven flash area (for AJAX errors)
  .alert.mt-3.d-none id="flash-area" role="alert"
    span id="flash-text"

.container-fluid
  hr.my-4
  form role="form" id="research-interest-form"
    .row.align-items-center
      .col-md-2.d-flex.align-items-center
        .h4.mb-0.fw-bold Research Interest
      .col-md-8
        input.form-control type="text" name="term" id="research_interest_input" placeholder="Please enter your research interest"
        .progress.mt-2.d-none id="search-progress"
          .progress-bar.progress-bar-striped.progress-bar-animated role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 75%;"
      .col-md-2
        button type="submit" id="embed-button" class="btn btn-primary w-100"
          span.spinner-grow.spinner-grow-sm.d-none role="status" aria-hidden="true"
          span.button-text Embed

  hr.my-4
  form role="form" action="/selected_journals" method='GET' id='find-journals-form'
    .row.align-items-center
      .col-md-2.d-flex.align-items-center
        .h4.mb-0.fw-bold Select Journals
      .col-md-4
        select name='journal1' id='journal_select1' class="form-control"
          - AcaRadar::View::JournalOption.all.each do |text, value|
            option value=value = text
      .col-md-4
        select name='journal2' id='journal_select2' class="form-control"
          - AcaRadar::View::JournalOption.all.each do |text, value|
            option value=value = text
      .col-md-2
        button type='submit' id='find-button' class="btn btn-primary w-100"
          span.spinner-grow.spinner-grow-sm.d-none role="status" aria-hidden="true"
          span.button-text Find
          
  hr.my-4
  h4.mb-3.fw-bold Previously Viewed Papers

  - if watched_papers.any?
    - watched_papers.each do |p|
      - url = (p['pdf_url'] || p[:pdf_url]).to_s
      - title = (p['title'] || p[:title]).to_s
      - published = (p['published'] || p[:published]).to_s

      .card.bg-light.mb-3
        .card-body
          h5.card-title
            - if url.empty?
              = title.empty? ? "Untitled paper" : title
            - else
              a href=url target="_blank" rel="noopener noreferrer" = (title.empty? ? url : title)

          - unless published.empty?
            p.small.text-muted
              | Published on: #{published}

  - else
    .alert.alert-light role="alert"
      h4.alert-heading Welcome!
      p You haven't viewed any papers yet. Use the form above to find some interesting research papers.

  javascript:
    const API_HOST = "#{@api_host}";
    console.log("0. [Frontend] API defined:", API_HOST);
    document.addEventListener("DOMContentLoaded", function() {

      const flashArea = document.getElementById('flash-area');
      const flashText = document.getElementById('flash-text');

      function showFlash(type, msg) {
        if (!flashArea || !flashText) return;
        flashArea.classList.remove('d-none', 'alert-danger', 'alert-success', 'alert-warning', 'alert-info');
        flashArea.classList.add(type); // e.g. 'alert-danger'
        flashText.textContent = msg || 'Something went wrong.';
      }

      function clearFlash() {
        if (!flashArea || !flashText) return;
        flashText.textContent = '';
        flashArea.classList.add('d-none');
      }

      // ==========================================
      // 1. Research Interest Form (AJAX + Faye)
      // ==========================================
      const researchForm = document.getElementById('research-interest-form');
      const progressBarContainer = document.getElementById('search-progress');
      const progressBar = progressBarContainer ? progressBarContainer.querySelector('.progress-bar') : null;
      const embedButton = document.getElementById('embed-button');

      let researchInterestVector = null;
      let researchInterestRequestId = null;

      // Safety Check
      if (researchForm) {
        researchForm.addEventListener('submit', async function(e) {
          e.preventDefault(); // Stop page reload

          const termInput = document.getElementById('research_interest_input').value;
          console.log("1. [Frontend] Form submitted. Term:", termInput);

          // --- A. RESET UI ---
          embedButton.disabled = true;
          embedButton.querySelector('.button-text').innerText = "Starting...";
          clearFlash();
          
          // Reset and show progress bar
          progressBarContainer.classList.remove('d-none');
          if(progressBar) {
              progressBar.style.width = '0%';
              progressBar.setAttribute('aria-valuenow', 0);
              progressBar.innerText = '0%';
              progressBar.classList.add('progress-bar-animated'); // Start animation
          }

          try {
            // --- B. CALL API (Port 9292) ---
            console.log("2. [Frontend] Sending POST request to ${API_HOST}...");
            
            const response = await fetch('/api_proxy/research_interest', {
              credentials: 'same-origin',
              method: 'POST',
              headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json' 
              },
              body: JSON.stringify({ term: termInput })
            });

            const result = await response.json().catch(() => ({}));
            const data = result.data || {};

            if (!response.ok) {
              // API returns message + data.error; prefer the friendliest
              const msg =
                (data && (data.error || data.message)) ||
                result.message ||
                `Server Error: ${response.status} ${response.statusText}`;
              throw new Error(msg);
            }

            console.log("3. [Frontend] API Response received:", result);

            // --- C. GET REQUEST ID ---
            const requestId = data.request_id || null;

            if (!requestId) {
              throw new Error("Response did not contain a request_id in result.data");
            }

            researchInterestRequestId = requestId;

            if (data.status === 'completed' || data.cached) {
              researchInterestVector = data.vector_2d || null;

              if (progressBar) {
                progressBar.style.width = '100%';
                progressBar.setAttribute('aria-valuenow', 100);
                progressBar.innerText = '100%: Cached';
                progressBar.classList.remove('progress-bar-animated');
              }

              embedButton.disabled = false;
              embedButton.querySelector('.button-text').innerText = "Done";
              return;
            }

            console.log("4. [Frontend] Request ID obtained:", requestId);
            embedButton.querySelector('.button-text').innerText = "Processing...";

            if (!window.Faye) throw new Error("Faye client not loaded (window.Faye is undefined)");
            const client = new window.Faye.Client('http://localhost:9292/faye');

            console.log(`5. [Faye] Subscribing to channel: /${requestId}`);

            const subscription = client.subscribe('/' + requestId, function(message) {
              console.log("6. [Faye] Message Received:", message);

              const pct = (message && message.percent !== undefined) ? message.percent
                        : (message && message.payload && message.payload.percent !== undefined) ? message.payload.percent
                        : null;

              const msgText = (message && message.message) ? message.message
                            : (message && message.payload && message.payload.message) ? message.payload.message
                            : '';

              if (progressBar && pct !== null) {
                progressBar.style.width = pct + '%';
                progressBar.setAttribute('aria-valuenow', pct);
                progressBar.innerText = `${pct}%: ${msgText || 'Processing...'}`;
              }

              const vec = (message && message.vector_2d) ||
                          (message && message.payload && message.payload.vector_2d);

              if (vec) {
                researchInterestVector = vec;
              }

              const done = (message && (message.status === 'complete' || message.status === 'completed')) ||
                          (message && message.payload && (message.payload.status === 'complete' || message.payload.status === 'completed')) ||
                          (pct !== null && pct >= 100);

              if (done) {
                if (progressBar) {
                  progressBar.style.width = '100%';
                  progressBar.setAttribute('aria-valuenow', 100);
                  progressBar.innerText = `100%: Done`;
                  progressBar.classList.remove('progress-bar-animated');
                }
                embedButton.disabled = false;
                embedButton.querySelector('.button-text').innerText = "Done";
              }
            });

            subscription.then(function() {
              console.log("5b. [Faye] Subscription active/successful.");
            });


          } catch (error) {
            console.error("!!! [Frontend] Error:", error);
            showFlash('alert-danger', error.message);

            // Reset button so user can try again
            if (progressBar) {
              progressBar.classList.remove('progress-bar-animated');
            }
            embedButton.disabled = false;
            embedButton.querySelector('.button-text').innerText = "Embed";
          }
        });
      } else {
        console.warn("Could not find element #research-interest-form");
      }

      // ==========================================
      // 2. Find Journals Form (Modified Logic)
      // ==========================================
      const journalsForm = document.getElementById('find-journals-form');
      if (journalsForm) {
          // --- ACTION 3: Change 'submit' to listen for the button 'click' instead ---
          const findButton = document.getElementById('find-button');
          findButton.addEventListener('click', function(e) {
              e.preventDefault(); // IMPORTANT: Stop the default form submission

              // --- A. Get journal values ---
              const journal1 = document.getElementById('journal_select1').value;
              const journal2 = document.getElementById('journal_select2').value;
              const term = document.getElementById('research_interest_input').value;

              // --- B. Check if we have the vector ---
              if (!researchInterestVector) {
                  alert("Please 'Embed' a research interest first!");
                  return;
              }

              // --- C. Show loading state ---
              const spinner = findButton.querySelector('.spinner-grow');
              const buttonText = findButton.querySelector('.button-text');
              findButton.disabled = true;
              spinner.classList.remove('d-none');
              buttonText.textContent = '   Loading...';

              // --- D. Build the new URL with all the data ---
              if (!researchInterestRequestId) {
                alert("Research interest is still processing (no request_id). Please embed first.");
                return;
              }

              const params = new URLSearchParams({
                term: term,
                journal1: journal1,
                journal2: journal2,
                vector_x: researchInterestVector[0],
                vector_y: researchInterestVector[1],
                request_id: researchInterestRequestId
              });

              const newUrl = `/selected_journals?${params.toString()}`;
              console.log("Redirecting to:", newUrl);

              // --- E. Redirect the browser ---
              window.location.href = newUrl;
          });
          }
          });